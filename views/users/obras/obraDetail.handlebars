<div class="container-fluid pl-4 pr-4">
    <div class="row">
        <div class="col-4">
            <h2>Obra</h2>
        </div>

        {{#ifUR}}
        <div class="col-8 text-right">
            <button type="button" class="btn btn-light btn-outline-info mr-2" onclick="saltaParaEdit()" style="cursor: pointer;"><i class="fa fa-edit"></i> Editar</button>
            <button type="button" class="btn btn-light btn-outline-info mr-2" onclick="saltaParaAddTarefa()" style="cursor: pointer;"><i class="fa fa-plus-circle"></i> Nova Tarefa</button>
            <button type="button" class="btn btn-light btn-outline-info mr-2" onclick="saltaParaDownloadReportCliente()" style="cursor: pointer;"><i class="fa fa-download"></i> Download Orçamento</button> 
            {{#ifImAdmin}}
                {{#ifWaitForClient obra.estado}}
                    <button type="button" class="btn btn-light btn-outline-info mr-2" onclick="saltaParaObraAceite()" style="cursor: pointer;"><i class="	fa fa-thumbs-up"></i> Cliente Aceitou</button>
                    <button type="button" class="btn btn-light btn-outline-info mr-2" onclick="saltaParaObraRecusada()" style="cursor: pointer;"><i class="	fa fa-thumbs-down"></i> Cliente Recusou</button>
                {{/ifWaitForClient}}
                <button type="button" class="btn btn-light btn-outline-info" onclick="saltaParaDownloadReport()" style="cursor: pointer;"><i class="fa fa-download"></i> Download Relatório</button>
            {{/ifImAdmin}}
        </div>
        {{/ifUR}}
    </div>
    <hr>

            <input type="hidden" id="id" name="id" value="{{obra._id}}">
            <div class="row mt-4 col-12" id="infoHover">
                <div class="col-3 p-3 text-left">
                    <h6 class="blockquote m-0" id="texto">Nome</h6>
                </div>
                <div class="col-9 p-3" id="texto">
                    <label for="nome" id="nomeObra" class="m-0">{{obra.nome}}</label>
                </div>
            </div>

            <div class="row mt-4 col-12" id="infoHover">
                <div class="col-3 p-3 text-left">
                    <h6 class="blockquote m-0">Descrição</h6>
                </div>
                <div class="col-9 p-3">
                    <label for="descricao" class="m-0" id="descricao">{{obra.descricao}}</label>
                </div>
            </div>

            <div class="row mt-4 col-12" id="infoHover">
                <div class="col-3 p-3 text-left" id="texto">
                    <h6 class="blockquote m-0">Estado</h6>
                </div>
                <div class="col-9 p-3" id="texto">
                    <label for="estado" id="estado" class="m-0">{{estadoToString obra.estado}}</label>
                </div>
            </div>

            {{#ifImAdmin}}
                <div class="row mt-4 col-12" id="infoHover">
                    <div class="col-3 p-3 text-left">
                        <h6 class="blockquote m-0">Despesa</h6>
                    </div>
                    
                    <div class="col-9 p-3">
                        <label for="nome" id="nomeObra" class="m-0">{{precoToString obra.despesa}}</label>
                    </div>
                </div>

                <div class="row mt-4 col-12" id="infoHover">
                    <div class="col-3 p-3 text-left">
                        <h6 class="blockquote m-0">Percentagem de lucro</h6>
                    </div>
                    
                    <div class="col-9 p-3">
                        <label for="nome" id="nomeObra" class="m-0">{{obra.percentagemLucro}}%</label>
                    </div>
                </div>

                <div class="row mt-4 col-12" id="infoHover">
                    <div class="col-3 p-3 text-left">
                        <h6 class="blockquote m-0">Orçamento</h6>
                    </div>
                    
                    <div class="col-9 p-3">
                        <label for="nome" id="nomeObra" class="m-0">{{precoToString obra.orcamento}}</label>
                    </div>
                </div>

                <div class="row mt-4 col-12" id="infoHover">
                    <div class="col-3 p-3 text-left">
                        <h6 class="blockquote m-0">Custo final</h6>
                    </div>

                    <div class="col-9 p-3">
                        <label for="estado" id="estado" class="m-0">{{precoToString obra.custoFinal}}</label>
                    </div>
                </div>
            {{else}}
            {{/ifImAdmin}}
            
            <div class="row mt-4 col-12" id="infoHover">
                
                <div class="col-3 p-3 text-left">
                    <h6 class="blockquote m-0">Datas previstas</h6>
                </div>
                
                <div class="col-9 p-3">
                    {{dateToString obra.dataPrevistaInicio}} - {{dateToString obra.dataPrevistaFim}}
                </div>
            </div>


            <div class="row mt-4 col-12" id="infoHover">
                <div class="col-3 p-3 text-left">
                    <h6 class="blockquote m-0">Datas</h6>
                </div>
                <div class="col-9 p-3">
                    {{dateToString obra.dataInicio}} - {{dateToString obra.dataFim}}
                </div>
            </div>

            <div class="row mt-5 text-center">
                <div class="col-12">
                    <h6 class="blockquote">Tarefas</h6>
                </div>
            </div>

            {{#if tarefas}}
                <table class="mt-5 mb-5" id="myTable">
                    <thead>
                    <tr>
                        <th onclick="sortTable(0)">Nome <i class="float-righ fa fa-sort"> </i></th>
                        <th onclick="sortTable(1)">Data prevista de inicio <i class="fa fa-sort"> </i></th>
                        <th onclick="sortTable(2)">Data prevista de fim <i class="fa fa-sort"> </i></th>
                        <th onclick="sortTable(3)">Estado <i class="fa fa-sort"> </i></th>
                        <th onclick="sortTable2(4)">Progresso <i class="fa fa-sort"> </i>
                        </th>
                    </tr>
                    </thead>
            
                    <tbody id="filtro">
                        {{#each tarefas}}
                            <tr id="row" data-name="{{_id}}" onclick="saltaParaTarefa(this)">
                                <td>{{nome}}</td>
                                <td>{{dateToString dataPrevistaInicio}}</td>
                                <td>{{dateToString dataPrevistaFim}}</td>
                                <td>{{estadoToStringOD estado}}</td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" id ="{{progresso}}" role="progressbar" style="width: {{progresso}}%;" aria-valuenow="{{progresso}}" aria-valuemin="0" aria-valuemax="100" value="{{progresso}}">{{progresso}}%</div>
                                    </div>
                                </td>
                            </tr>
                        {{else}}

                        {{/each}}
                    </tbody>
                </table>
                {{else}}
                <div class="row text-center mt-4 mb-5">
                    <div class="col-12 font-weight-bold">Sem tarefas associadas à obra</div>
                </div>
            {{/if}}  
</div>
   <script>
        function saltaParaAddTarefa(){
            obra = document.getElementById('id').getAttribute("value");
            window.location.href = "/obra/"+obra+"/addTarefa";
        }

        function saltaParaTarefa(handle) {
            window.location.href = "/tarefa/"+handle.dataset.name;
        }

        function saltaParaEdit() {
            obra = document.getElementById('id').getAttribute("value");
            window.location.href = "/obra/"+obra+"/edit";
        }


        function saltaParaDownloadReport() {
            obra = document.getElementById('id').getAttribute("value");
            window.location.href = "/obra/"+obra+"/downloadReport";
        }

        function saltaParaDownloadReportCliente() {
            obra = document.getElementById('id').getAttribute("value");
            window.location.href = "/obra/"+obra+"/downloadClientReport";
        }

        function saltaParaObraAceite() {
            obra = document.getElementById('id').getAttribute("value");
            window.location.href = "/obra/"+obra+"/clientAccepted";
        }

        function saltaParaObraRecusada() {
            obra = document.getElementById('id').getAttribute("value");
            window.location.href = "/obra/"+obra+"/clientRejected";
        }

        
        function sortTable(n) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            table = document.getElementById("myTable");
            switching = true;
        
            dir = "asc"; 
        
            while (switching) {
            
            switching = false;
            rows = table.rows;
            
            for (i = 1; i < (rows.length - 1); i++) {
                
                shouldSwitch = false;
                
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                
                if (dir == "asc") {
                if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                    shouldSwitch= true;
                    break;
                }
                } else if (dir == "desc") {
                if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                    shouldSwitch = true;
                    break;
                }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount ++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                dir = "desc";
                switching = true;
                }
            }
            }
        } 

        function sortTable2(n) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            table = document.getElementById("myTable");
            switching = true;
        
            dir = "asc"; 
        
            while (switching) {
            
            switching = false;
            rows = table.rows;
            
            for (i = 1; i < (rows.length - 1); i++) {
                
                shouldSwitch = false;
                
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                var xN = parseInt(x.getElementsByTagName("div")[1].getAttribute("id"))
                var yN = parseInt(y.getElementsByTagName("div")[1].getAttribute("id"))
                if (dir == "asc") {
                if (xN > yN) {
                    shouldSwitch= true;
                    break;
                }
                } else if (dir == "desc") {
                if (xN < yN) {
                    shouldSwitch = true;
                    break;
                }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount ++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                dir = "desc";
                switching = true;
                }
            }
            }
        } 
   </script>
